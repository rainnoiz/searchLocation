<!DOCTYPE html>
<html>
  <head>
    <title>Simple Map</title>
    <!--Theme JQuery-->
    <link href="Script/jquery-ui-1.10.3.custom/development-bundle/themes/base/jquery-ui.css" rel="stylesheet" />
    <script src="Script/jquery-ui-1.10.3.custom/js/jquery-1.9.1.js"></script>
    <script src="Script/jquery-ui-1.10.3.custom/js/jquery-ui-1.10.3.custom.js"></script>
    
    <!--appendGrid-->
    <link href="Plugin/appendGrid/jquery.appendGrid-1.3.1.css" rel="stylesheet" />
    <script src="Plugin/appendGrid/jquery.appendGrid-1.3.1.js"></script>

    <!--Google Map API-->
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>


    <script>        //Google Map API
        var map;
        var markersSup = [];
        var markersCus = [];
        var markerLocation;
        function initialize() {
            var location = new google.maps.LatLng(13.75, 100.517);
            var mapOptions = {
                zoom: 6,
                center: location,
                draggable: true,
                animation: google.maps.Animation.DROP,
            };
            map = new google.maps.Map(document.getElementById('map-canvas'),
                mapOptions);
        }

        /*Add a marker to the map and push to the array.*/
        function AddMarkersSup() {
            //var markerSup = {};
            var location = new google.maps.LatLng(13.75, 100.517);
            var markerSup = new google.maps.Marker({
                position: location,
                map: map,
                draggable: true,
                animation: google.maps.Animation.DROP,
                icon: 'Image/iconBlue.png',
                myID: markersSup.length,
                supName: ""
            });
            markersSup.push(markerSup);
            //markerSup.set('myID') = markersSup.length;
            //alert(markerSup.get('myID'));
            var rowIndex = $('#gridSupplier').appendGrid('getRowIndex', markersSup.length);
              google.maps.event.addListener(markerSup, 'position_changed', function() {
                var path = markerSup.getPosition();
                //var rowIndex = $('#gridSupplier').appendGrid('getRowIndex', markerSup.get('myID')); //$('#tblAppendGrid').appendGrid('getRowIndex', uniqueIndex);
                $('#gridSupplier').appendGrid('setCtrlValue', 'supLocation', rowIndex, path.toString().substring(1, (path.toString().length - 1)));
            }); 
        }

        function AddMarkersCus() {
            var location = new google.maps.LatLng(13.75, 100.517);
            var markerCus = new google.maps.Marker({
                position: location,
                map: map,
                draggable: true,
                animation: google.maps.Animation.DROP,
                icon: 'Image/iconPink.png',
                myID: markersCus.length.toString(),
                cusName: ""
            });

            markersCus.push(markerCus);
            var rowIndex = $('#gridCustomer').appendGrid('getRowIndex', markersCus.length);
            google.maps.event.addListener(markerCus, 'position_changed', function () {
                var path = markerCus.getPosition();
                var rowIndex = $('#gridCustomer').appendGrid('getRowIndex', markersCus.length);
                $('#gridCustomer').appendGrid('setCtrlValue', 'cusLocation', rowIndex, path.toString().substring(1, (path.toString().length - 1)));
            });
        }

        /*Delete all markers*/
        function DeleteAllMarkers() {
            //Delete markers
            for (var i = 0; i < markersSup.length; i++) {
                markersSup[i].setMap(null);
            }
            for (var i = 0; i < markersCus.length; i++) {
                markersCus[i].setMap(null);
            }
            //markersSup = [];
            //markersCus = [];
          //  markerLocation.setMap(null);

            //Delete row
            DeleteAllRows();
        }

        /*Delete row supplier*/
        function DeleteMapSup(id) {
            markersSup[id].setMap(null);
        }

        /*Delete row customer*/
        function DeleteMapCus(id) {
            markersCus[id].setMap(null);
        }

        /* Dragable marker */
        function toggleBounce() {

            if (markers.getAnimation() != null) {
                markers.setAnimation(null);
            } else {
                marker.setAnimation(google.maps.Animation.BOUNCE);
            }
        }

        /*Show infomation window*/
        function mapInfoSup(id, info) {
            var infoWindow = new google.maps.InfoWindow({
                content: info
                });
            infoWindow.open(map, markersSup[id]);
            markersSup[id].supName = info;
        }

        function mapInfoCus(id, info)
        {
            var infoWindow = new google.maps.InfoWindow({
                content: info
            });
            
            infoWindow.open(map, markersCus[id]);
        }

        function CreateLocationMark(lat, lan)
        {
            if (markerLocation) {
                markerLocation.setMap(null);
                markerLocation = null;
                
            }
            var location = new google.maps.LatLng(lat, lan);
            markerLocation = new google.maps.Marker({
                position: location,
                map: map,
                animation: google.maps.Animation.DROP,
                icon: 'Image/iconOrange.png',
            });
            var infoWindow = new google.maps.InfoWindow({
                content: lat + ", " + lan
            });
            infoWindow.open(map, markerLocation);
        }

        google.maps.event.addDomListener(window, 'load', initialize);

    </script>

    <script>//Button
         $(function () {
             $("button")
             .button()
             .click(function (event) {
                 event.preventDefault();
             });
         });
    </script>

    <script>
        /* appendGrid */
        jQuery(document).ready(function ($) {
            $(function () {

                /*Supplier*/
                $('#gridSupplier').appendGrid({
                    initRows: 0,
                    columns: [
                    {
                        name: 'supName', display: 'Name', type: 'text', ctrlAttr: { maxlength: 200 }, displayCss: { width: '30%' },
                            onChange: function (evt, rowIndex) /*Have a change in this cell go to show mapInfo on marker*/
                            {
                                var id = $('#gridSupplier').appendGrid('getUniqueIndex', rowIndex);
                                var info = $('#gridSupplier').appendGrid('getCtrlValue', 'supName', rowIndex);
                                mapInfoSup(id-1,info);
                            }
                    },
                    { name: 'supCost', display: 'Costs', type: 'text', ctrlAttr: { maxlength: 100 }, displayCss: { width: '15%' } },
                    { name: 'supQuantity', display: 'Quantities', type: 'text', ctrlAttr: { maxlength: 100 }, displayCss: { width: '15%' } },
                    { name: 'supLocation', display: 'Location', type: 'text', ctrlAttr: { maxlength: 100 }, displayCss: { width: '40%' } },
                    { name: 'supRecordId', type: 'hidden', value: 0 }
                    ],
                    customRowButtons: [
                        {
                            uiButton: { icons: { primary: 'ui-icon-trash' } },
                            click: function (evtObj, uniqueIndex, rowData) {
                                DeleteRowSub(uniqueIndex);
                                DeleteMapSup(uniqueIndex-1);
                            }
                        }
                    ],
                    customFooterButtons: [
                        {
                            uiButton: { icons: { primary: 'ui-icon-plusthick' } },
                            btnCss: { 'color': '#ff0000' },
                            btnClass: 'append',
                            click: function (evt)
                            {
                                InsertRow(1);
                            },
                            atTheFront: true
                        }
                    ],
                    caption: null,
                    hideRowNumColumn: true,
                    hideButtons: {
                        moveUp:true,
                        moveDown: true,
                        insert: true,
                        remove: true,
                        removeLast: true,
                        append:true
                    }
                });

                /*Customer*/
                $('#gridCustomer').appendGrid({
                    initRows: 0,
                    columns: [
                    {
                      name: 'cusName', display: 'Name', type: 'text', ctrlAttr: { maxlength: 200 }, displayCss: { width: '30%' },
                            onChange: function (evt, rowIndex) /*Have a change in this cell go to show mapInfo on marker*/
                            {
                                var id = $('#gridCustomer').appendGrid('getUniqueIndex', rowIndex);
                                var info = $('#gridCustomer').appendGrid('getCtrlValue', 'cusName', rowIndex);
                                mapInfoCus(id-1,info);
                            }
                    },
                    { name: 'cusCost', display: 'Costs', type: 'text', ctrlAttr: { maxlength: 100 }, displayCss: { width: '15%' } },
                    { name: 'cusQuantity', display: 'Quantities', type: 'text', ctrlAttr: { maxlength: 100 }, displayCss: { width: '15%' } },
                    { name: 'cusLocation', display: 'Location', type: 'text', ctrlAttr: { maxlength: 100 }, displayCss: { width: '40%' } },
                    { name: 'cusRecordId', type: 'hidden', value: 0 }
                    ],
                    customRowButtons: [
                            {
                                uiButton: { icons: { primary: 'ui-icon-trash' } },
                                click: function (evtObj, uniqueIndex, rowData)
                                {
                                    DeleteRowCus(uniqueIndex);
                                    DeleteMapCus(uniqueIndex - 1);
                                }
                            }
                    ],
                    customFooterButtons: [
                        {
                            uiButton: { icons: { primary: 'ui-icon-plusthick' } },
                            btnCss: { 'color': '#ff0000' },
                            btnClass: 'append',
                            click: function (evt) {
                                InsertRow(2);
                            },
                            atTheFront: true
                        }
                    ],
                    caption: null,
                    hideRowNumColumn: true,
                    hideButtons: {
                        moveUp: true,
                        moveDown: true,
                        insert: true,
                        remove: true,
                        removeLast: true,
                        append: true
                    }
                });
            });
        });
    </script>

    <script type="text/javascript">

        /*Calculate location*/
        function FindLocation() {
            /*Supplier*/
            var dataSup = $('#gridSupplier').appendGrid('getAllValue');
            var i = 0;
            var checkValue;
            var dataSubCosts = new Array();
            for (i = 0; i < dataSup.length; i++) {
                checkValue = ($('#gridSupplier').appendGrid('getAllValue'))[i].supCost.toString();
                if (checkValue =="0" || checkValue == "") {
                    dataSubCosts[i] = "1";
                }
                else {
                    dataSubCosts[i] = checkValue;
                }
                
            }
            var dataSubQuan = new Array();
            for (i = 0; i < dataSup.length; i++) {
                checkValue = ($('#gridSupplier').appendGrid('getAllValue'))[i].supQuantity.toString();
                if (checkValue == "0" || checkValue == "") {
                    dataSubQuan[i] = "1";
                }
                else {
                    dataSubQuan[i] = checkValue;
                }
            }
            var dataSubLat = new Array();
            var dataSubLan = new Array();
            for (i = 0; i < dataSup.length; i++)
            {
                var dataSubLocations = ($('#gridSupplier').appendGrid('getAllValue'))[i].supLocation.toString();
                var dataSubLocation = dataSubLocations.split(",");
                dataSubLat[i] = dataSubLocation[0];
                dataSubLan[i] = dataSubLocation[1];
            }
            
            /*Customer*/
            var dataCus = $('#gridCustomer').appendGrid('getAllValue');
            var i = 0;
            var dataCusCosts = new Array();
            for (i = 0; i < dataCus.length; i++) {
                checkValue = ($('#gridCustomer').appendGrid('getAllValue'))[i].cusCost.toString();
                if (checkValue == "0" || checkValue == "") {
                    dataCusCosts[i] = "1";
                }
                else {
                    dataCusCosts[i] = checkValue;
                }
            }
            var dataCusQuan = new Array();
            for (i = 0; i < dataCus.length; i++) {
                checkValue = ($('#gridCustomer').appendGrid('getAllValue'))[i].cusQuantity.toString();
                if (checkValue == "0" || checkValue == "") {
                    dataCusQuan[i] = "1";
                }
                else {
                    dataCusQuan[i] = checkValue;
                }
            }
            var dataCusLat = new Array();
            var dataCusLan = new Array();
            for (i = 0; i < dataCus.length; i++) {
                var dataCusLocations = ($('#gridCustomer').appendGrid('getAllValue'))[i].cusLocation.toString();
                var dataCusLocation = dataCusLocations.split(",");
                dataCusLat[i] = dataCusLocation[0];
                dataCusLan[i] = dataCusLocation[1];
            }

            /*Calculate Location*/
            var horizontalSup = 0, verticalSup = 0, horizontalCus = 0, verticalCus = 0, costQuanSup = 0, costQuanCus = 0;
            var horizontal, vertical, costQuan;
            var locationLat, locationLan;
            var rowCountSup = $('#gridSupplier').appendGrid('getRowCount');
            var rowCountCus = $('#gridCustomer').appendGrid('getRowCount');
            var j;
            for (j = 0; j < rowCountSup; j++) {
                horizontalSup += (dataSubCosts[j] * dataSubQuan[j] * dataSubLat[j]);
                verticalSup += (dataSubCosts[j] * dataSubQuan[j] * dataSubLan[j]);
                costQuanSup += dataSubCosts[j] * dataSubQuan[j];
            }
            
            for (j = 0; j < rowCountCus; j++) {
                horizontalCus += (dataCusCosts[j] * dataCusQuan[j] * dataCusLat[j]);
                verticalCus += (dataCusCosts[j] * dataCusQuan[j] * dataCusLan[j]);
                costQuanCus += dataCusCosts[j] * dataCusQuan[j];
            } 
            horizontal = horizontalSup + horizontalCus;
            vertical = verticalSup + verticalCus;
            costQuan = costQuanSup + costQuanCus;
            locationLat = horizontal / costQuan;
            locationLan = vertical / costQuan;
            //alert(horizontalSup + ", " + horizontalCus);
            
            CreateLocationMark(locationLat, locationLan);
        }


        /*Inser row and marker*/
        function InsertRow(type) {
            if (type == 1) {
                var rowCountSup = $('#gridSupplier').appendGrid('getRowCount');
                $('#gridSupplier').appendGrid('insertRow', 1, rowCountSup);
                AddMarkersSup();
            }
            else {
                var rowCountCus = $('#gridCustomer').appendGrid('getRowCount');
                $('#gridCustomer').appendGrid('insertRow', 1, rowCountCus);
                AddMarkersCus();
            }
        }
        /*Delete row for supplier*/
        function DeleteRowSub(uniqueIndex) {
            var rowIndex = $('#gridSupplier').appendGrid('getRowIndex', uniqueIndex);
            $('#gridSupplier').appendGrid('removeRow', rowIndex, uniqueIndex);
        }
        /*Delete row for customer*/
        function DeleteRowCus(uniqueIndex) {
            var rowIndex = $('#gridCustomer').appendGrid('getRowIndex', uniqueIndex);
            $('#gridCustomer').appendGrid('removeRow', rowIndex, uniqueIndex);
        }

        function DeleteAllRows()
        {
            var rowCountSub = $('#gridSupplier').appendGrid('getRowCount');
            if (rowCountSub > 0) {
                for (var i = rowCountSub-1; i >=  0; i--) {
                    $('#gridSupplier').appendGrid('removeRow', i);
                }
            }

            var rowCountCus = $('#gridCustomer').appendGrid('getRowCount');
            if (rowCountCus > 0) {
                for (var i = rowCountCus-1; i >= 0; i--) {
                    $('#gridCustomer').appendGrid('removeRow', i);
                }
            }
        }
    </script>

  </head>
  <body>
      <section id="secMap">
           <div id="myinfo" class="info"><p>I am a div on top of a google map .. </p></div>
          <article id="map-canvas"></article>
      </section>

      <section id="secCal"  class="ui-accordion ui-widget ui-helper-reset" role="tablist">
        <h3 id="ui-accordion-accordion-header-0" class="ui-accordion-header ui-helper-reset ui-state-default ui-corner-all ui-accordion-icons" role="tab" aria-controls="ui-accordion-accordion-panel-0" aria-selected="true" tabindex="0">
          <a href="#" style="font-weight: bold">Supplier</a>
        </h3>
        <article id="ui-accordion-accordion-panel-0" class="ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom ui-accordion-content-active" style="display: block;" aria-labelledby="ui-accordion-accordion-header-0" role="tabpanel" aria-expanded="true" aria-hidden="false">
            <table id="gridSupplier"></table>
        </article>
        
        <h3 id="ui-accordion-accordion-header-1" class="ui-accordion-header ui-helper-reset ui-state-default ui-corner-all ui-accordion-icons" role="tab" aria-controls="ui-accordion-accordion-panel-0" aria-selected="true" tabindex="0">
          <a href="#" style="font-weight: bold">Customer</a>
        </h3>
          <article id="ui-accordion-accordion-panel-1" class="ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom ui-accordion-content-active" style="display: block;" aria-labelledby="ui-accordion-accordion-header-1" role="tabpanel" aria-expanded="true" aria-hidden="false">
          <table id="gridCustomer"></table>
        </article>

        <section id="button">
          <button id="btnSubmit" onclick="FindLocation();">Find Location</button>
          <button id="btnClear" onclick="DeleteAllMarkers();">Clear</button>
            <input id="hidMarkID" type="hidden" />
        </section>
      </section>
  </body>
</html>

    